import React, { useState, useEffect } from 'react';
import { Calendar, Plus, Trash2, Check, AlertCircle } from 'lucide-react';

const AvailabilityApp = () => {
  const [name, setName] = useState('');
  const [nameValid, setNameValid] = useState(null);
  const [selectedMonday, setSelectedMonday] = useState('');
  const [availabilities, setAvailabilities] = useState({});
  const [showConfirmation, setShowConfirmation] = useState(false);
  const [submittedData, setSubmittedData] = useState([]);
  const [validNames, setValidNames] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

  // Get next 8 Mondays
  const getNextMondays = () => {
    const mondays = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const currentDay = today.getDay();
    // Calculate days until next Monday (1 = Monday, 0 = Sunday)
    let daysUntilMonday;
    if (currentDay === 0) { // Sunday
      daysUntilMonday = 1;
    } else if (currentDay === 1) { // Monday
      daysUntilMonday = 0; // Include today if it's Monday
    } else { // Tuesday through Saturday
      daysUntilMonday = 8 - currentDay;
    }
    
    const nextMonday = new Date(today);
    nextMonday.setDate(today.getDate() + daysUntilMonday);
    
    for (let i = 0; i < 8; i++) {
      const monday = new Date(nextMonday);
      monday.setDate(nextMonday.getDate() + (i * 7));
      mondays.push(monday.toISOString().split('T')[0]);
    }
    return mondays;
  };

  const mondays = getNextMondays();

  // Fetch valid names from Google Sheets
  useEffect(() => {
    const fetchValidNames = async () => {
      try {
        setLoading(true);
        // Replace with your actual Google Sheets URL that's published to the web as CSV
        const sheetUrl = 'YOUR_GOOGLE_SHEETS_CSV_URL_HERE';
        const response = await fetch(sheetUrl);
        const text = await response.text();
        const lines = text.split('\n').filter(line => line.trim());
        // Assuming names are in the first column
        const names = lines.slice(1).map(line => line.split(',')[0].trim()).filter(n => n);
        setValidNames(names);
        setLoading(false);
      } catch (err) {
        // For demo purposes, use hardcoded names if fetch fails
        setValidNames(['Alice Johnson', 'Bob Smith', 'Carol Davis', 'David Wilson', 'Emma Brown']);
        setLoading(false);
      }
    };
    fetchValidNames();
  }, []);

  // Validate name
  useEffect(() => {
    if (name.trim() === '') {
      setNameValid(null);
    } else {
      setNameValid(validNames.includes(name.trim()));
    }
  }, [name, validNames]);

  const addAvailability = (day) => {
    const newAvailability = {
      id: Date.now(),
      startTime: '',
      endTime: '',
      comment: ''
    };
    setAvailabilities(prev => ({
      ...prev,
      [day]: [...(prev[day] || []), newAvailability]
    }));
  };

  const removeAvailability = (day, id) => {
    setAvailabilities(prev => ({
      ...prev,
      [day]: prev[day].filter(a => a.id !== id)
    }));
  };

  const updateAvailability = (day, id, field, value) => {
    setAvailabilities(prev => ({
      ...prev,
      [day]: prev[day].map(a => a.id === id ? { ...a, [field]: value } : a)
    }));
  };

  const getDateForDay = (dayName) => {
    if (!selectedMonday) return '';
    const monday = new Date(selectedMonday);
    const dayIndex = days.indexOf(dayName);
    const date = new Date(monday);
    date.setDate(monday.getDate() + dayIndex);
    return date.toISOString().split('T')[0];
  };

  const handleSubmit = () => {
    if (!name.trim() || !selectedMonday) {
      setError('Please enter your name and select a week.');
      return;
    }

    const hasAvailabilities = Object.values(availabilities).some(arr => arr && arr.length > 0);
    if (!hasAvailabilities) {
      setError('Please add at least one availability.');
      return;
    }

    const submissionTime = new Date().toISOString();
    const data = [];

    days.forEach(day => {
      const dayAvails = availabilities[day] || [];
      dayAvails.forEach(avail => {
        if (avail.startTime && avail.endTime) {
          data.push({
            submissionTime,
            name: name.trim(),
            weekName: selectedMonday,
            dayOfWeek: day,
            date: getDateForDay(day),
            startTime: avail.startTime,
            endTime: avail.endTime,
            comment: avail.comment
          });
        }
      });
    });

    setSubmittedData(data);
    setShowConfirmation(true);
    setError('');
  };

  const resetForm = () => {
    setShowConfirmation(false);
    setName('');
    setSelectedMonday('');
    setAvailabilities({});
    setSubmittedData([]);
    setError('');
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Loading...</p>
        </div>
      </div>
    );
  }

  if (showConfirmation) {
    return (
      <div className="min-h-screen bg-gray-50 p-8">
        <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6">
          <div className="flex items-center gap-2 mb-6 text-green-600">
            <Check className="w-6 h-6" />
            <h2 className="text-2xl font-bold">Submission Confirmed</h2>
          </div>
          
          <div className="overflow-x-auto">
            <table className="w-full border-collapse text-sm">
              <thead>
                <tr className="bg-gray-100">
                  <th className="border p-2 text-left">Submission Time (UTC)</th>
                  <th className="border p-2 text-left">Name</th>
                  <th className="border p-2 text-left">Week (Monday)</th>
                  <th className="border p-2 text-left">Day</th>
                  <th className="border p-2 text-left">Date</th>
                  <th className="border p-2 text-left">Start Time</th>
                  <th className="border p-2 text-left">End Time</th>
                  <th className="border p-2 text-left">Comment</th>
                </tr>
              </thead>
              <tbody>
                {submittedData.map((row, idx) => (
                  <tr key={idx} className="hover:bg-gray-50">
                    <td className="border p-2">{row.submissionTime}</td>
                    <td className="border p-2">{row.name}</td>
                    <td className="border p-2">{row.weekName}</td>
                    <td className="border p-2">{row.dayOfWeek}</td>
                    <td className="border p-2">{row.date}</td>
                    <td className="border p-2">{row.startTime}</td>
                    <td className="border p-2">{row.endTime}</td>
                    <td className="border p-2">{row.comment || '-'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <button
            onClick={resetForm}
            className="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            New Entry
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 className="text-3xl font-bold mb-6 text-gray-800">Weekly Availability Entry</h1>

        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-700">
            <AlertCircle className="w-5 h-5" />
            <span>{error}</span>
          </div>
        )}

        <div className="space-y-6">
          {/* Name Input */}
          <div>
            <label className="block text-sm font-medium mb-2">Your Name</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none ${
                nameValid === false ? 'border-red-500' : nameValid === true ? 'border-green-500' : 'border-gray-300'
              }`}
              placeholder="Enter your name"
            />
            {nameValid === false && (
              <p className="mt-1 text-sm text-amber-600 flex items-center gap-1">
                <AlertCircle className="w-4 h-4" />
                Warning: Name not found in authorized list
              </p>
            )}
            {nameValid === true && (
              <p className="mt-1 text-sm text-green-600">Name verified âœ“</p>
            )}
          </div>

          {/* Week Selection */}
          <div>
            <label className="block text-sm font-medium mb-2">Select Week (Monday)</label>
            <div className="relative">
              <Calendar className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
              <select
                value={selectedMonday}
                onChange={(e) => setSelectedMonday(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              >
                <option value="">Choose a Monday</option>
                {mondays.map(monday => (
                  <option key={monday} value={monday}>
                    {new Date(monday).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {/* Daily Availabilities */}
          {selectedMonday && (
            <div className="space-y-4">
              <h2 className="text-xl font-semibold">Daily Availability</h2>
              {days.map(day => (
                <div key={day} className="border border-gray-200 rounded-lg p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="font-medium">
                      {day} - {getDateForDay(day)}
                    </h3>
                    <button
                      onClick={() => addAvailability(day)}
                      className="flex items-center gap-1 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                    >
                      <Plus className="w-4 h-4" />
                      Add Slot
                    </button>
                  </div>

                  <div className="space-y-2">
                    {(availabilities[day] || []).map(avail => (
                      <div key={avail.id} className="flex gap-2 items-start bg-gray-50 p-3 rounded">
                        <input
                          type="time"
                          value={avail.startTime}
                          onChange={(e) => updateAvailability(day, avail.id, 'startTime', e.target.value)}
                          className="px-2 py-1 border border-gray-300 rounded text-sm"
                        />
                        <span className="self-center">to</span>
                        <input
                          type="time"
                          value={avail.endTime}
                          onChange={(e) => updateAvailability(day, avail.id, 'endTime', e.target.value)}
                          className="px-2 py-1 border border-gray-300 rounded text-sm"
                        />
                        <input
                          type="text"
                          value={avail.comment}
                          onChange={(e) => updateAvailability(day, avail.id, 'comment', e.target.value.slice(0, 200))}
                          placeholder="Comment (optional)"
                          maxLength={200}
                          className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                        />
                        <button
                          onClick={() => removeAvailability(day, avail.id)}
                          className="p-1 text-red-600 hover:bg-red-50 rounded"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                    {(!availabilities[day] || availabilities[day].length === 0) && (
                      <p className="text-sm text-gray-500 italic">No availability for this day</p>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Submit Button */}
          <button
            onClick={handleSubmit}
            disabled={!name.trim() || !selectedMonday}
            className="w-full py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
          >
            Submit Availability
          </button>
        </div>
      </div>
    </div>
  );
};

export default AvailabilityApp;
